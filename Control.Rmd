---
title: "From MSDial on"
author: "Katherine Heal"
date: "August 28, 2019"
output: html_document
---
Organization notes:
As of 05/14/20, Skyline files for environmental samples have been moved to within their respective folders containing the .mzxml files for ease of file location (i.e. Manual_Integrations/HILICPos); Output from Skyline integrations of environmental samples are placed into "Manual_Integrations/DataProcessing/RawOutput"
All culture Skyline data are in rawDat files

Analysis notes:
AOA cell counts are just holder for now - everything needs to be rerun when those numbers are better
Cluster with or without AOA?  If without, we need to dump those cultures during the k-means calculations

Hello!

```{r, message=FALSE, error=FALSE}
library(tidyverse)
library(cowplot)
theme_set(theme_cowplot())
library(here)
```

#QC and tidy up culture samples
TO DO: Adjust and rerun with real (not just holder data) cell counts for the AOA
Run the QC for each fraction, combine and make tidy to compare with environmental samples
```{r, message=FALSE, error=FALSE, warning=FALSE, }
source("SourceCode/QC_HILICPos_Cultures.R")

remove(list = ls())

source("SourceCode/QC_HILICNeg_Cultures.R")
remove(list = ls())

source("SourceCode/QC_RP_Cultures.R")
remove(list = ls())

source("SourceCode/Combine_and_tidy_cultures.R")
remove(list = ls())
```

#BMIS on the HILIC output from Skyline, save output in BMISReports Folder, remove the intermediate output
```{r, error = FALSE, warning=FALSE, message=FALSE}
source('SourceCode/BMIS_QEHILIC.R')
ggsave("Intermediates/BMISReports/BMIS_IS_StandardsRep_HILIC.pdf", plot = BMISlist[[1]], device = "pdf", width = 10, height = 10, units = "in")
write_file(BMISlist[[2]], "Intermediates/BMISReports/BMIS_Summary_HILIC.txt")
ggsave("Intermediates/BMISReports/BMIS_IS_StandardsTest_HILIC.pdf", plot = BMISlist[[3]], device = "pdf", width = 10, height = 10, units = "in")
write_csv(BMISlist[[4]], "Intermediates/BMISReports/BMISd_Areas_long_HILIC.csv")
rm(BMISlist)
```


#BMIS on the CyanoAq output from Skyline, save output in BMISReports Folder, remove the intermediate output
```{r, error = FALSE, warning=FALSE, message=FALSE}
source('SourceCode/BMIS_QECyano.R')
ggsave("Intermediates/BMISReports/BMIS_IS_StandardsRep_Cyano.pdf", plot = BMISlist[[1]], device = "pdf", width = 10, height = 10, units = "in")
write_file(BMISlist[[2]], "Intermediates/BMISReports/BMIS_Summary_Cyano.txt")
ggsave("Intermediates/BMISReports/BMIS_IS_StandardsTest_Cyano.pdf", plot = BMISlist[[3]], device = "pdf", width = 10, height = 10, units = "in")
write_csv(BMISlist[[4]], "Intermediates/BMISReports/BMISd_Areas_long_Cyano.csv")

rm(BMISlist)
```

#Combine and Tidy environmental data, add in culture data
#TO DO: add in MS2 data to the wide area etc....
```{r, error = FALSE, warning=FALSE, message=FALSE}
source('SourceCode/Combine_Clean_nofunction.R')

#Add in the culture data
dat.file <- read_csv("Intermediates/WideArea_withIDinfo.csv")
culture.file <- read_csv("Intermediates/Culture_Intermediates/combined_wide_LogBioArea.csv")
combo.wide <- left_join(dat.file, culture.file)
write_csv(combo.wide, "Intermediates/WideArea_withIDinfo_withCultureLogBioArea.csv")

source('SourceCode/get_MS2s.R')

remove(list = ls())
```

#Quantify compounds that we are able to
#TO DO: adjust quantifications for cultures with ISs when appropriate
TO DO: rerun once AOA have better cell count numbers
```{r, error = FALSE, warning=FALSE, message=FALSE}
#Calculate RF and RF ratios for all our quantifiable compounds
source('SourceCode/CalculateRF_andRFratios.R')
remove(list = ls())

#Use RF and RF ratios to calculate concentrations in organisms
source('SourceCode/Quantification_Cultures.R')
remove(list = ls())

#Use RF and RF ratios to calculate concentrations in environmental samples 
source('SourceCode/Quantification_EnvironSamples.R')
remove(list = ls())
```

#Cluster the mass features using a K-means approach 
Assign each MF:dataset a cluster, save out cluster diagnostics for each sample set.  
Bootstrap the clusters to see if there is overexpressed overlap between clusters
TO DO: add a "significant under-overlap variable" 
TO DO: clean up cluster letters
```{r, error = FALSE, warning=FALSE, message=FALSE}
#To reorganize the clusters, rename them within this file
source("SourceCode/clustering_all_seperate.R") 
remove(list = ls())

source("SourceCode/bootstrap_clusters.R")
remove(list = ls())
```

#Get basic stats for results section
```{r, error = FALSE, warning=FALSE, message=FALSE}
source("SourceCode/Basiccalcs.R")
```


####Non essential work
#Write out files for Metabolomics Workbench
```{r}
source('SourceCode/Metab_WorkBench_Prepper.R')
remove(list = ls())
```

#Write out a file for CMAP export
```{r, error = FALSE, warning=FALSE, message=FALSE}
source('SourceCode/CMAP_maker.R')
cmap.results <- CMAPPER(quan.dat.file = "Intermediates/Quantified_LongDat.csv", metaG1.file = "MetaData/SampInfo_wMetaData_withUTC.csv")
# write.csv(cmap.results[[1]], "Intermediates/G1_GradientsTargeted_forCMAP.csv")
# write.csv(cmap.results[[2]], "Intermediates/G2_GradientsTargeted_forCMAP.csv")
remove(list = ls())
```

#Make some output for Anitra to peruse
```{r, error = FALSE, warning=FALSE, message=FALSE}
source('SourceCode/Summary_forAnitra.R')
```


TO DO: extract and plot up Gln/Glu in cultures
TO DO: extract and plot SAM/SAH in G1, G2; cultures
TO DO: extract and plot cystathionine in G1, G2; cultures
TO DO: extract and plot the phosphate one that Liz shows with 
TO DO: look at stoichiometry of metabolites
TO DO: make a generic wrapper for making plots of individual compounds that look really nice :)



